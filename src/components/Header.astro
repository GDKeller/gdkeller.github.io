---
import Link from "./Link.astro";
import Nav from "./Nav.astro";
import HeadshotMini from "./HeadshotMini.astro";
---

<div
  id="header__main"
  class="animate__header border-box sticky left-0 top-0 z-40 block w-full justify-between overflow-hidden border-b border-emerald-200 border-opacity-10 bg-black bg-opacity-85 px-4 py-2 shadow-sm backdrop-blur transition-shadow duration-100 [transform:translate3d(0,0,0)] sm:px-2"
>
  <div class="relative flex w-full items-center justify-between">
    <div class="box-border flex items-center gap-4">
      <div class="relative hidden h-8 w-8 shrink-0 md:block">
        <!-- Placeholder shown when hero is visible -->
        <div
          class="header-placeholder absolute inset-0 flex items-center justify-center transition-opacity duration-700"
        >
          <div
            class="oscilloscope h-7 w-7 overflow-hidden rounded-full border border-emerald-400/50 bg-black/50"
          >
            <svg class="h-full w-full p-0" viewBox="0 0 32 32" preserveAspectRatio="none">
              <polyline
                id="oscilloscope-wave"
                class="oscilloscope-wave"
                points="0,16 2,16 4,16 6,16 8,16 10,16 12,16 14,16 16,16 18,16 20,16 22,16 24,16 26,16 28,16 30,16 32,16"
                fill="none"
                stroke="currentColor"
                stroke-width="1.2"
                stroke-linecap="round"
                stroke-linejoin="round"></polyline>
            </svg>
          </div>
        </div>
        <!-- Headshot shown when scrolled past hero -->
        <a
          href="#"
          class="header-logo absolute inset-0 overflow-hidden rounded-full opacity-0 transition-opacity duration-700"
          aria-label="Scroll to top"
        >
          <HeadshotMini />
        </a>
      </div>
      <Nav class="" />
    </div>
    <div class="flex items-center gap-2 text-sm">
      <Link
        href="https://github.com/gdkeller"
        target="_blank"
        class="icon-link group hidden md:block"
      >
        <svg
          class="h-6 w-6 rounded-full bg-black/60 text-emerald-200 transition-all duration-200 group-hover:text-emerald-100 group-hover:drop-shadow-[0_0_6px_rgba(16,185,129,0.5)] group-focus-visible:text-emerald-100 group-focus-visible:drop-shadow-[0_0_6px_rgba(16,185,129,0.5)]"
          fill="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
          ></path>
        </svg>
        <span class="sr-only">GitHub</span>
      </Link>
      <Link
        href="https://www.linkedin.com/in/grantdkeller/"
        target="_blank"
        class="icon-link group hidden md:block"
      >
        <svg
          class="h-6 w-6 rounded bg-black/60 text-emerald-200 transition-all duration-200 group-hover:text-emerald-100 group-hover:drop-shadow-[0_0_6px_rgba(16,185,129,0.5)] group-focus-visible:text-emerald-100 group-focus-visible:drop-shadow-[0_0_6px_rgba(16,185,129,0.5)]"
          fill="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"
          ></path>
        </svg>
        <span class="sr-only">LinkedIn</span>
      </Link>
      <Link
        href="/Grant Keller Senior UX Engineer Resume 2025.pdf"
        target="_blank"
        variant="subtle"
        class="hidden items-center gap-1 rounded-sm border border-emerald-400/30 bg-emerald-900/20 px-2 py-1 leading-none transition-all hover:border-emerald-400/60 hover:bg-emerald-400/10 md:flex"
      >
        <span>Resume</span>
        <svg
          class="h-5 w-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          ></path>
        </svg>
      </Link>
      <button
        onclick="hire_me_modal.showModal()"
        class="flex items-center gap-1 rounded-sm border border-emerald-400/30 bg-emerald-900/20 px-2 py-1 text-emerald-200 transition-all duration-200 hover:border-emerald-400/60 hover:bg-emerald-400/10"
      >
        <span class="hidden leading-none sm:inline-block">Contact</span>
        <svg
          class="inline-block h-5 w-5 text-emerald-200"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"
          ></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  const headerLogo = document.querySelector(".header-logo");
  const headerPlaceholder = document.querySelector(".header-placeholder");
  const hero = document.querySelector("#hero");

  if (headerLogo && headerPlaceholder && hero) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // Hero is visible, hide headshot, show placeholder
            headerLogo.classList.add("opacity-0");
            headerLogo.classList.remove("opacity-100");
            headerPlaceholder.classList.remove("opacity-0");
            headerPlaceholder.classList.add("opacity-100");
          } else {
            // Hero is not visible, show headshot, hide placeholder
            headerLogo.classList.remove("opacity-0");
            headerLogo.classList.add("opacity-100");
            headerPlaceholder.classList.add("opacity-0");
            headerPlaceholder.classList.remove("opacity-100");
          }
        });
      },
      { threshold: 0.1 },
    );

    observer.observe(hero);
  }
</script>

<style>
  :global(.icon-link) {
    position: relative;
  }

  :global(.icon-link)::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 200%;
    height: 200%;
    transform: translate3d(-50%, -50%, 0) scale(1);
    background: radial-gradient(
      ellipse at center,
      theme("colors.emerald.400" / 20%) 0%,
      transparent 70%
    );
    border-radius: 50%;
    opacity: 0;
    transition:
      opacity 0.2s ease-in-out,
      transform 0.4s ease-in-out;
    pointer-events: none;
  }

  :global(.icon-link):hover::before,
  :global(.icon-link):focus-visible::before {
    opacity: 1;
    transform: translate3d(-50%, -50%, 0) scale(1.7);
  }

  .oscilloscope-wave {
    color: theme("colors.emerald.300");
    filter: blur(0.05rem);
  }

  @media (prefers-reduced-motion: reduce) {
    .oscilloscope-wave {
      display: none;
    }
  }
</style>

<script>
  import gsap from "gsap";

  const wave = document.getElementById("oscilloscope-wave");
  if (wave && !window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
    const numPoints = 17;
    const centerY = 16;
    const maxAmplitude = 14;

    // Store Y values for each point
    const yValues = Array(numPoints).fill(centerY);

    // Update the polyline points attribute
    function updateWave() {
      const points = yValues.map((y, i) => `${i * 2},${y}`).join(" ");
      wave!.setAttribute("points", points);
    }

    // Global energy level that all pairs respond to
    let globalEnergy = 0.3;
    let energyTimeoutId: number | null = null;
    let isPaused = false;

    // Randomly fluctuate energy - mostly low with occasional spikes
    function updateEnergy() {
      if (isPaused) return;
      const rand = Math.random();
      if (rand > 0.85) {
        // Spike! High energy burst
        globalEnergy = 0.85 + Math.random() * 0.15;
        energyTimeoutId = window.setTimeout(updateEnergy, 150 + Math.random() * 300);
      } else if (rand > 0.6) {
        // Medium activity
        globalEnergy = 0.3 + Math.random() * 0.3;
        energyTimeoutId = window.setTimeout(updateEnergy, 200 + Math.random() * 400);
      } else {
        // Low signal / quiet
        globalEnergy = 0.05 + Math.random() * 0.15;
        energyTimeoutId = window.setTimeout(updateEnergy, 300 + Math.random() * 800);
      }
    }

    // Pause/resume on visibility change to save resources
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        isPaused = true;
        if (energyTimeoutId) clearTimeout(energyTimeoutId);
        gsap.globalTimeline.pause();
      } else {
        isPaused = false;
        gsap.globalTimeline.resume();
        updateEnergy();
      }
    });

    updateEnergy();

    // Animate pairs of adjacent points that mirror each other
    function animatePair(index1: number, index2: number) {
      // Amplitude highest in center, tapering to edges
      const centerIndex = (numPoints - 1) / 2;
      const pairCenter = (index1 + index2) / 2;
      const distanceFromCenter = Math.abs(pairCenter - centerIndex) / centerIndex;
      const positionMultiplier = 1 - distanceFromCenter * 0.85;

      function oscillate() {
        // Combine position-based and global energy multipliers
        const amplitude = maxAmplitude * positionMultiplier * globalEnergy * (0.8 + Math.random() * 0.4);
        const duration = globalEnergy > 0.5
          ? 0.08 + Math.random() * 0.12  // Fast during high energy
          : 0.2 + Math.random() * 0.4;    // Slower during low energy

        // Both points move together but in opposite directions
        gsap.to(yValues, {
          [index1]: centerY - amplitude,
          [index2]: centerY + amplitude,
          duration: duration,
          ease: "sine.inOut",
          onUpdate: updateWave,
          onComplete: () => {
            gsap.to(yValues, {
              [index1]: centerY + amplitude,
              [index2]: centerY - amplitude,
              duration: duration,
              ease: "sine.inOut",
              onUpdate: updateWave,
              onComplete: () => {
                // Variable pause - longer during quiet periods
                const pause = globalEnergy > 0.5
                  ? duration * 0.2
                  : duration * 0.5 + Math.random() * 0.3;
                gsap.to(yValues, {
                  [index1]: centerY,
                  [index2]: centerY,
                  duration: pause,
                  ease: "sine.out",
                  onUpdate: updateWave,
                  onComplete: oscillate,
                });
              },
            });
          },
        });
      }

      oscillate();
    }

    // Create pairs of adjacent points (skip edges for cleaner look)
    for (let i = 1; i < numPoints - 2; i += 2) {
      setTimeout(
        () => animatePair(i, i + 1),
        i * 20 + Math.random() * 40,
      );
    }
  }
</script>
